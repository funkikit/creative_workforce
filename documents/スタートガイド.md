# スタートガイド：Creative Workforce PoC

このガイドでは、リポジトリをローカルで動かしてPoCを試すまでの手順と、GCPへのデプロイ準備の概要をまとめています。詳細な仕様は `documents/PoC仕様書.md`・`documents/ディレクトリとアーキテクチャ案.md` を参照してください。

---

## 1. 事前準備
- **必須ツール**
  - Python 3.11/3.12
  - [uv](https://github.com/astral-sh/uv)（Python依存管理）
  - Node.js 18+ と pnpm
  - Docker と docker-compose（ローカル依存サービス用）
  - GCP デプロイ時：`gcloud` CLI、Terraform（任意）、Google Cloud プロジェクト
- **リポジトリ初期化**
  ```bash
  git clone https://github.com/funkikit/creative_workforce.git
  cd creative_workforce
  ```

---

## 2. ローカル環境セットアップ
1. **環境変数テンプレートコピー**
   ```bash
   cp config/env/.env.local.example config/env/.env.local
   cp config/env/.env.example backend/.env
   ```
   → OpenAI/Geminiキーがある場合は `.env.local` に追記。

2. **バックエンド依存インストール**
   ```bash
   cd backend
   uv sync
   ```

3. **フロントエンド依存インストール**
   ```bash
   cd ../frontend
   pnpm install
   ```

4. **Docker Compose で依存コンテナ起動**
   ```bash
  cd ..
  docker-compose -f infrastructure/docker-compose.yaml up -d postgres minio redis
  ```

5. **バックエンド／ワーカー／フロントエンド起動**
   ```bash
   # Backend API (FastAPI + Uvicorn)
   cd backend
   uv run python -m scripts.run_dev

   # 別ターミナルで: 画像生成ワーカー（キュー処理確認に使用）
   uv run fastapi dev app/main.py --host 0.0.0.0 --port 8001 --app app.workers.router
   # ※PoCでは HTTP タスク呼び出しのためバックエンド本体に /api/tasks が組み込まれています。

   # フロントエンド
   cd ../frontend
   pnpm dev --port 3000
   ```
   ブラウザで `http://localhost:3000` にアクセスし、PoCコンソールから以下を検証できます。
   - プロジェクト作成／一覧表示
   - LangGraphエージェントによる成果物生成（テキストは即時、キーフレームはキューへ）
   - 「Run worker now」で `/api/tasks/generate-keyframe` を呼び出し画像生成をシミュレート
   - 生成成果物閲覧（テキスト／画像プレビュー）と不足テンプレートの確認

6. **テスト実行（任意）**
   ```bash
   cd backend
   uv run pytest
   ```

---

## 3. GCP デプロイ準備（概要）

> 本番向け IaC は未整備のため、以下はクラウド移行時に必要となる構成のハイレベルガイドです。`config/env/.env.gcp.example` を参照しつつ設定を固めてください。

1. **GCP リソース**
   - Cloud Run（Backend / Frontend / Worker をコンテナ化してデプロイ）
   - Cloud SQL（PostgreSQL）
   - Cloud Storage（成果物ファイル用バケット）
   - Cloud Tasks（画像生成ジョブのキュー）
   - Vertex AI（埋め込み、必要に応じて Gemini API）
   - Secret Manager（APIキー、DBパスワード管理）

2. **環境変数設定**
   ```bash
   cp config/env/.env.gcp.example backend/.env
   # 値を自分のプロジェクトに合わせて編集
   ```
   主な項目：
   - `GCP_PROJECT` / `GCP_LOCATION`
   - `GCS_BUCKET`, `CLOUD_TASKS_*`
   - `OPENAI_API_KEY`, `GEMINI_API_KEY`
   - `NEXT_PUBLIC_API_BASE_URL`（Cloud Run 経由の公開URL）

3. **コンテナビルド＆デプロイ例**
   ```bash
   # backend
   gcloud builds submit --config infrastructure/cloudbuild/backend.yaml .

   # frontend
   gcloud builds submit --config infrastructure/cloudbuild/frontend.yaml .
   ```
   ※Cloud Build/Terraformの定義は今後追加予定。現状は `Dockerfile.backend` / `Dockerfile.frontend` をベースに `gcloud run deploy` で手動デプロイできます。

4. **Cloud Tasks → Worker 連携**
   - Cloud Tasks から Backend の `/api/tasks/generate-keyframe` へ HTTP POST するように設定（Service Account に必要なIAM権限を付与）。
   - Vertex AI や Gemini を利用する場合、ワーカー環境に API キー／サービスアカウント権限を配布する。

5. **動作確認**
   - Cloud Run 上で Backend / Frontend が起動後、`NEXT_PUBLIC_API_BASE_URL` をフロント環境変数に反映 → `pnpm build && pnpm start`.
   - Cloud Tasks に手動でジョブ投入し、ワーカーが成果物を GCS へ保存することを確認。

---

## 4. トラブルシュート
- **`uv run python -m scripts.run_dev` でモジュールが見つからない**
  → `backend` ディレクトリで実行しているか確認し、仮想環境が `.venv/` に生成されているかチェック。
- **Frontend から API へ接続できない**
  → `.env.local` の `NEXT_PUBLIC_API_BASE_URL` と CORS 設定を確認。ローカルは `http://localhost:8000/api` が既定。
- **Cloud Tasks が 401/403 を返す**
  → 対象Service Accountに `Cloud Tasks Enqueuer` と Cloud Run 実行用の IAM ロールを付与し、OIDC トークン設定を行う。
- **WSL で Backend 起動時に端末が固まる**
  → `fastapi dev` は `backend/.venv` を含むディレクトリ全体を監視するため、WSL の inotify ブリッジを圧迫しやすい。`uv run python -m scripts.run_dev` では監視対象を `app/` と `tests/` に限定し `.venv` を除外しているため、こちらを利用してください。

---

以上でローカルPoCの起動とクラウド移行の見取り図が整います。疑問点や改善事項は `documents/TODO.md` に追記して運用してください。
